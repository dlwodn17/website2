<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GyeonChilll's Room</title>
    <link rel="icon" href="image/home_logo2.png">
    <link rel="stylesheet" href="index.css">
    <script src="navigation.js"></script>
    
    <!-- Cloudflare Turnstile -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    
    <script type="module">
        import { 
          getAuth, 
          onAuthStateChanged,
          signInWithPopup,
          GoogleAuthProvider,
          signOut
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
          getFirestore,
          collection,
          addDoc,
          getDocs,
          deleteDoc,
          doc,
          query,
          orderBy,
          onSnapshot
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      
        const firebaseConfig = {
          apiKey: "AIzaSyCJxwZOo07cM-M2uO45q0jGTbEobIRL8Y4",
          authDomain: "gyeonchill-s-room.firebaseapp.com",
          projectId: "gyeonchill-s-room",
          storageBucket: "gyeonchill-s-room.firebasestorage.app",
          messagingSenderId: "31487965786",
          appId: "1:31487965786:web:bffd8fff97eccbddee3663",
          measurementId: "G-BLMNC5NFP4"
        };
      
        try {
          const app = initializeApp(firebaseConfig);
          const db = getFirestore(app);
          const auth = getAuth(app);
      
          window.firebaseDB = db;
          window.firebaseAuth = auth;
          window.firebaseCollection = collection;
          window.firebaseAddDoc = addDoc;
          window.firebaseGetDocs = getDocs;
          window.firebaseDeleteDoc = deleteDoc;
          window.firebaseDoc = doc;
          window.firebaseQuery = query;
          window.firebaseOrderBy = orderBy;
          window.firebaseOnSnapshot = onSnapshot;
          window.firebaseInitialized = true;
      
          // 인증 관련 모듈 메서드를 전역에 노출
          const googleProvider = new GoogleAuthProvider();
          window.firebaseAuthModule = {
            signInWithPopup,
            GoogleAuthProvider,
            googleProvider,
            signOut,
            onAuthStateChanged,
            auth
          };
      
          console.log("Firebase 초기화 완료");
        } catch (error) {
          console.error("Firebase 초기화 오류:", error);
          window.firebaseInitialized = false;
        }
      </script>
      
    
    <!-- Google Analytics 태그 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XWWBCPB03C"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XWWBCPB03C');
    </script>
    
    <style>
        .board-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .board-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .write-form {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        
        .write-form h2 {
            margin-top: 0;
            color: whitesmoke;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: whitesmoke;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: 'suite_medium';
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .cf-turnstile {
            margin: 10px 0;
        }
        
        .submit-btn {
            background-color: #361278;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'suite_medium';
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .submit-btn:hover {
            background-color: #4a1a9f;
        }
        
        .posts-container {
            margin-top: 30px;
        }
        
        .post-item {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            transition: transform 0.2s;
        }
        
        .post-item:hover {
            transform: translateY(-2px);
        }
        
        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .post-title {
            font-size: 18px;
            font-weight: bold;
            color: whitesmoke;
            margin: 0;
        }
        
        .post-meta {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .post-content {
            color: whitesmoke;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .delete-btn {
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            font-family: 'suite_medium';
        }
        
        .delete-btn:hover {
            background-color: #c82333;
        }
        
        .empty-message {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            padding: 40px;
            font-size: 16px;
        }
        
        .loading-message {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            padding: 20px;
            font-size: 14px;
        }
        
        .error-message {
            background-color: rgba(220, 53, 69, 0.2);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid rgba(220, 53, 69, 0.5);
        }
        
        .config-notice {
            background-color: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 193, 7, 0.5);
        }

        .auth-panel {
            background-color: rgba(0, 0, 0, 0.25);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: whitesmoke;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }
        
        .auth-panel button {
            background-color: #361278;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            font-family: 'suite_medium';
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .auth-panel button:hover {
            background-color: #4a1a9f;
        }
        
        .google-login-btn {
            background-color: #4285f4 !important;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .google-login-btn:hover {
            background-color: #357ae8 !important;
        }
        
        .google-icon {
            width: 18px;
            height: 18px;
            background-color: white;
            border-radius: 2px;
            display: inline-block;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%234285f4' d='M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z'/%3E%3Cpath fill='%2334a853' d='M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z'/%3E%3Cpath fill='%23fbbc05' d='M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z'/%3E%3Cpath fill='%23ea4335' d='M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .auth-status {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        @media (max-width: 768px) {
            .board-container {
                padding: 10px;
            }
            
            .post-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .delete-btn {
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <script>
        // 네비게이션 바 생성 및 삽입
        const nav = new NavigationBar('Board.html');
        nav.insertToBody();
    </script>
    
    <div class="content">
        <div class="board-container">
            <div class="board-header">
                <h1>게시판</h1>
                <p>자유롭게 글을 작성하고 공유하세요!</p>
            </div>
            
            <!-- 글 작성 폼 -->
            <div class="write-form">
                <h2>새 글 작성</h2>
                <!-- Google 로그인 패널 -->
                <div class="auth-panel">
                    <span class="auth-status" id="authStatus">로그인되지 않았습니다.</span>
                    <button type="button" id="googleLoginButton" class="google-login-btn">
                        <span class="google-icon"></span>
                        Google 계정으로 로그인
                    </button>
                    <button type="button" id="logoutButton" style="display:none;">로그아웃</button>
                </div>
                <form id="postForm">
                    <div class="form-group">
                        <label for="author">작성자</label>
                        <input type="text" id="author" name="author" placeholder="작성자 이름을 입력하세요" required>
                    </div>
                    <div class="form-group">
                        <label for="title">제목</label>
                        <input type="text" id="title" name="title" placeholder="글 제목을 입력하세요" required>
                    </div>
                    <div class="form-group">
                        <label for="content">내용</label>
                        <textarea id="content" name="content" placeholder="글 내용을 입력하세요" required></textarea>
                    </div>
                    <div class="form-group">
                        <!-- Cloudflare Turnstile 위젯 -->
                        <!-- Site Key를 Cloudflare 대시보드에서 받아서 아래 YOUR_SITE_KEY를 교체하세요 -->
                        <div class="cf-turnstile" data-sitekey="0x4AAAAAACHwixAsFsWEp5z3" data-theme="auto"></div>
                    </div>
                    <button type="submit" class="submit-btn">글 작성</button>
                </form>
            </div>
            
            <!-- 게시글 목록 -->
            <div class="posts-container">
                <h2 style="color: whitesmoke; margin-bottom: 20px;">게시글 목록</h2>
                <div id="errorMessage"></div>
                <div id="postsList">
                    <div class="loading-message">게시글을 불러오는 중...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        
        // 에러 메시지 표시
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `<div class="error-message">${escapeHtml(message)}</div>`;
        }
        
        // 설정 안내 메시지 표시
        function showConfigNotice() {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `
                <div class="config-notice">
                    <strong>⚠️ Firebase 설정이 필요합니다</strong><br>
                    Board.html 파일의 Firebase 설정 부분에 본인의 Firebase 프로젝트 정보를 입력해주세요.<br>
                    Firebase 콘솔(https://console.firebase.google.com)에서 프로젝트를 생성하고 설정 정보를 복사해 붙여넣으세요.
                </div>
            `;
        }
        
        // XSS 방지를 위한 HTML 이스케이프
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 게시글 목록 렌더링
        function renderPosts(posts) {
            const postsList = document.getElementById('postsList');
            const currentUser = window.firebaseAuth.currentUser;
            const adminUid = "O7Bhjx4WkIS0pbfkvH9lbAtajds2"; // 관리자 UID
            
            if (!posts || posts.length === 0) {
                postsList.innerHTML = '<div class="empty-message">아직 작성된 글이 없습니다. 첫 번째 글을 작성해보세요!</div>';
                return;
            }
            
            postsList.innerHTML = posts.map(post => {
                // --- 권한 확인 로직 ---
                // 1. 내가 관리자인가?
                const isAdmin = currentUser && currentUser.uid === adminUid;
                // 2. 내가 이 글을 쓴 사람인가? (글에 저장된 uid와 내 uid 비교)
                const isOwner = currentUser && post.uid === currentUser.uid;
                
                // 관리자이거나 작성자일 때만 삭제 버튼 코드를 생성하고, 아니면 빈 문자열('')을 만듭니다.
                const deleteBtnHtml = (isAdmin || isOwner) 
                    ? `<button class="delete-btn" data-post-id="${escapeHtml(post.id)}">삭제</button>` 
                    : '';
                // ----------------------------

                return `
                    <div class="post-item">
                        <div class="post-header">
                            <div>
                                <h3 class="post-title">${escapeHtml(post.title)}</h3>
                                <div class="post-meta">작성자: ${escapeHtml(post.author)} | 작성일: ${post.date}</div>
                            </div>
                            ${deleteBtnHtml} </div>
                        <div class="post-content">${escapeHtml(post.content)}</div>
                    </div>
                `;
            }).join('');
            
            // 삭제 버튼에 이벤트 리스너 추가 (이벤트 위임 사용)
            attachDeleteListeners();
        }
        
        // Firebase에서 게시글 가져오기
        async function loadPosts() {
            try {
                if (!window.firebaseDB) {
                    showConfigNotice();
                    document.getElementById('postsList').innerHTML = '<div class="empty-message">Firebase가 초기화되지 않았습니다.</div>';
                    return;
                }
                
                const postsRef = window.firebaseCollection(window.firebaseDB, 'posts');
                const q = window.firebaseQuery(postsRef, window.firebaseOrderBy('timestamp', 'desc'));
                const querySnapshot = await window.firebaseGetDocs(q);
                
                const posts = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    posts.push({
                        id: doc.id,
                        author: data.author,
                        title: data.title,
                        content: data.content,
                        date: data.date || new Date(data.timestamp?.toDate()).toLocaleString('ko-KR'),
                        uid: data.uid
                    });
                });
                
                renderPosts(posts);
                document.getElementById('errorMessage').innerHTML = '';
            } catch (error) {
                console.error('게시글 로드 오류:', error);
                showError('게시글을 불러오는 중 오류가 발생했습니다: ' + error.message);
                document.getElementById('postsList').innerHTML = '<div class="empty-message">게시글을 불러올 수 없습니다.</div>';
            }
        }
        
        // Firebase에 게시글 추가하기
        async function addPost(author, title, content) {
            try {
                if (!window.firebaseDB) {
                    showError('Firebase가 초기화되지 않았습니다. Firebase 설정을 확인해주세요.');
                    return;
                }
                
                const postsRef = window.firebaseCollection(window.firebaseDB, 'posts');
                const now = new Date();

                const currentUser = window.firebaseAuth.currentUser;
                // 사용자가 있다면 그 사용자의 고유 ID(uid)를 가져오고, 없다면 null을 넣습니다.
                const userUid = currentUser ? currentUser.uid : null;
                
                await window.firebaseAddDoc(postsRef, {
                    author: author,
                    title: title,
                    content: content,
                    uid: userUid,
                    date: now.toLocaleString('ko-KR'),
                    timestamp: now
                });
                
                // 실시간 업데이트를 위해 다시 로드
                await loadPosts();
            } catch (error) {
                console.error('게시글 추가 오류:', error);
                showError('게시글 작성 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // Firebase에서 게시글 삭제하기
        async function deletePost(id) {
            if (!confirm('정말 삭제하시겠습니까?')) {
                return;
            }
            
            try {
                if (!window.firebaseDB) {
                    showError('Firebase가 초기화되지 않았습니다.');
                    return;
                }
                
                const postRef = window.firebaseDoc(window.firebaseDB, 'posts', id);
                await window.firebaseDeleteDoc(postRef);
                
                // 실시간 업데이트를 위해 다시 로드
                await loadPosts();
            } catch (error) {
                console.error('게시글 삭제 오류:', error);
                showError('게시글 삭제 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // 삭제 버튼에 이벤트 리스너 추가 (이벤트 위임 사용)
        let deleteHandler = null;
        
        function attachDeleteListeners() {
            const postsList = document.getElementById('postsList');
            if (!postsList) return;
            
            // 기존 리스너가 있으면 제거 (중복 방지)
            if (deleteHandler) {
                postsList.removeEventListener('click', deleteHandler);
            }
            
            // 이벤트 위임: postsList 컨테이너에 단일 리스너 추가
            deleteHandler = function(e) {
                // 클릭된 요소가 삭제 버튼인지 확인
                if (e.target.classList.contains('delete-btn')) {
                    const postId = e.target.getAttribute('data-post-id');
                    if (postId) {
                        deletePost(postId);
                    }
                }
            };
            
            postsList.addEventListener('click', deleteHandler);
        }
        
        // 폼 제출 이벤트
        document.getElementById('postForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const author = document.getElementById('author').value.trim();
            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();

            // 로그인 여부 확인
            const currentUser = window.firebaseAuth && window.firebaseAuth.currentUser;
            if (!currentUser) {
                showError('글 작성은 Google 로그인 후 가능합니다. 상단 로그인 버튼을 이용해 로그인해 주세요.');
                return;
            }
            
            // Turnstile 토큰 확인
            const turnstileResponse = document.querySelector('input[name="cf-turnstile-response"]');
            if (!turnstileResponse || !turnstileResponse.value) {
                showError('보안 검증을 완료해주세요.');
                return;
            }
            
            if (author && title && content) {
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                
                await addPost(author, title, content);
                
                this.reset();
                if (window.turnstile) {
                    window.turnstile.reset();  // Turnstile 토큰 초기화
                }
                submitBtn.disabled = false;
                
                // 스크롤을 게시글 목록으로 이동
                document.querySelector('.posts-container').scrollIntoView({ behavior: 'smooth' });
            }
        });
        
        // Firebase 초기화 대기 후 게시글 로드
        // Firebase 모듈이 로드될 때까지 대기
        let loadAttempts = 0;
        const maxAttempts = 20; // 최대 10초 대기
        
        function waitForFirebase() {
            if (window.firebaseDB && window.firebaseInitialized) {
                loadPosts();
                // 실시간 업데이트 설정
                try {
                    const postsRef = window.firebaseCollection(window.firebaseDB, 'posts');
                    const q = window.firebaseQuery(postsRef, window.firebaseOrderBy('timestamp', 'desc'));
                    window.firebaseOnSnapshot(q, (snapshot) => {
                        loadPosts();
                    });
                } catch (error) {
                    console.error('실시간 업데이트 설정 오류:', error);
                    // 실시간 업데이트 실패해도 일반 로드는 계속
                    loadPosts();
                }
            } else if (loadAttempts < maxAttempts) {
                loadAttempts++;
                setTimeout(waitForFirebase, 500);
            } else {
                // Firebase가 초기화되지 않았거나 설정이 안 된 경우
                if (!window.firebaseInitialized) {
                    showConfigNotice();
                    document.getElementById('postsList').innerHTML = '<div class="empty-message">Firebase 설정이 필요합니다. FIREBASE_SETUP.md 파일을 참고하세요.</div>';
                } else {
                    showError('Firebase 연결에 실패했습니다. 설정을 확인해주세요.');
                }
            }
        }
        
        // 페이지 로드 시 게시글 목록 표시 및 이벤트 리스너 초기화
        window.addEventListener('DOMContentLoaded', function() {
            // Google 로그인/로그아웃 버튼 이벤트
            const googleLoginBtn = document.getElementById('googleLoginButton');
            const logoutBtn = document.getElementById('logoutButton');
            const authStatus = document.getElementById('authStatus');

            function updateAuthUI(user) {
                if (!authStatus || !logoutBtn || !googleLoginBtn) return;
                if (user) {
                    const displayName = user.displayName || user.email || '사용자';
                    authStatus.textContent = `${displayName}님으로 로그인되어 있습니다.`;
                    googleLoginBtn.style.display = 'none';
                    logoutBtn.style.display = 'inline-block';
                } else {
                    authStatus.textContent = '로그인되지 않았습니다.';
                    googleLoginBtn.style.display = 'inline-flex';
                    logoutBtn.style.display = 'none';
                }
            }

            if (window.firebaseAuthModule && window.firebaseAuthModule.onAuthStateChanged) {
                window.firebaseAuthModule.onAuthStateChanged(window.firebaseAuthModule.auth, (user) => {
                    updateAuthUI(user);
                });
            }

            if (googleLoginBtn) {
                googleLoginBtn.addEventListener('click', async () => {
                    if (!window.firebaseAuthModule) {
                        showError('Firebase 인증 모듈이 초기화되지 않았습니다.');
                        return;
                    }
                    try {
                        await window.firebaseAuthModule.signInWithPopup(
                            window.firebaseAuthModule.auth, 
                            window.firebaseAuthModule.googleProvider
                        );
                        showError(''); // 에러 영역 초기화
                    } catch (err) {
                        console.error('Google 로그인 오류:', err);
                        if (err.code === 'auth/popup-closed-by-user') {
                            showError('로그인 팝업이 닫혔습니다. 다시 시도해주세요.');
                        } else {
                            showError('Google 로그인 실패: ' + err.message);
                        }
                    }
                });
            }

            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    if (!window.firebaseAuthModule) return;
                    try {
                        await window.firebaseAuthModule.signOut(window.firebaseAuthModule.auth);
                        showError(''); // 에러 영역 초기화
                    } catch (err) {
                        showError('로그아웃 실패: ' + err.message);
                    }
                });
            }

            // 삭제 버튼 이벤트 리스너 초기화 (이벤트 위임)
            attachDeleteListeners();
            setTimeout(waitForFirebase, 500);
        });
    </script>
</body>
</html>

